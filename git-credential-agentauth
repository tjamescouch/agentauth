#!/bin/sh
# git-credential-agentauth — git credential helper that fetches tokens
# from the agentauth proxy. Keeps secrets out of agent containers.
#
# Install:
#   git config --global credential.helper '/path/to/git-credential-agentauth'
#
# Or with custom proxy URL:
#   git config --global credential.helper '/path/to/git-credential-agentauth --proxy http://localhost:9999'
#
# The helper only responds to "get" operations for github.com.
# It queries the agentauth proxy's /agentauth/credential/github endpoint.

set -e

PROXY_URL="${AGENTAUTH_URL:-http://localhost:9999}"

# Parse arguments
while [ $# -gt 0 ]; do
  case "$1" in
    --proxy) PROXY_URL="$2"; shift 2 ;;
    --proxy=*) PROXY_URL="${1#--proxy=}"; shift ;;
    *) shift ;;
  esac
done

# git credential protocol: read key=value pairs from stdin
operation="${1:-get}"

# Only handle "get" — store and erase are no-ops (proxy manages tokens)
if [ "$operation" != "get" ]; then
  exit 0
fi

# Read input from git
host=""
protocol=""
while IFS='=' read -r key value; do
  case "$key" in
    host) host="$value" ;;
    protocol) protocol="$value" ;;
    "") break ;;
  esac
done

# Only serve github.com requests
case "$host" in
  github.com|*.github.com) ;;
  *) exit 0 ;;
esac

# Query agentauth proxy for the token
response=$(curl -sf "${PROXY_URL}/agentauth/credential/github" 2>/dev/null) || {
  # Proxy unavailable or no credential — let git try other helpers
  exit 0
}

# Extract token from JSON response (minimal parsing, no jq dependency)
token=$(printf '%s' "$response" | sed -n 's/.*"token"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p')

if [ -z "$token" ]; then
  exit 0
fi

# Output in git credential protocol format
printf 'protocol=%s\n' "${protocol:-https}"
printf 'host=%s\n' "${host}"
printf 'username=x-access-token\n'
printf 'password=%s\n' "${token}"
